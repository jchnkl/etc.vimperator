" settings
set tabnumbers

" Show or hide Firefox's GUI elements like
" the menu bar, toolbars or the tab bar.
" gui=menu, tabs, navigation, bookmarks, addons
set gui=none,tabs

" When on, it blurs any textbox which often is
" automatically focused on page load.
set focuscontent

" mappings
mapclear
map <silent> A :b#<CR>
map <silent> J 3j
map <silent> K 3k
map <silent> S :tabopen about:sync-tabs<CR>
" panorama mappings
map <silent> ps :panorama switch <Tab>
map <silent> pa :panorama add! 
map <silent> pu :panorama pushtab <Tab>
map <silent> pr :panorama remove<CR>
map <silent> pp :js sortTabByDomain(gLastValidURLStr);<CR>
map <silent> pv <C-S-e>
map <silent> p <Nop>

" clear autocmds
autocmd!

autocmd VimperatorEnter .* -js Weave.Service.sync();
autocmd LocationChange .*(google..*|.*portal.sparkasse-nuernberg.de.*|dict\.leo\.org) <Esc>
autocmd PageLoad .*(google..*|.*portal.sparkasse-nuernberg.de.*|dict\.leo\.org) <Esc>
autocmd PageLoadPre .*(google..*|.*portal.sparkasse-nuernberg.de.*|dict\.leo\.org) <Esc>

" autocmd PageLoadPre .* js sortTabByDomain("<url>");

javascript << EOJS

function sortTabByDomain( url ) {
  var groupName = getBareDomain( url );
  if ( groupName == false ) {
    return;
  } else {
    pushTabToGroup ( findTabForURL( url ), groupName );
  }
}

function findTabForURL( url ) {
  for ( i=tabs.get().length-1; i>=0; i-- ) {
    if ( tabs.getTab(i).linkedBrowser.currentURI.spec == url ) {
      return tabs.getTab(i);
    }
  }
}

function pushTabToGroup( tab, groupName ) {

  for each ( var tg in tabGroup.tabView.GroupItems.groupItems ) {

    if (tg.getTitle() == groupName) {
      tabGroup.moveTab( tab, tg, false );
      return;
    }

  }
  tabGroup.createGroup(groupName, false, tab);

}

// extract example from www.example.com
function getBareDomain( url ) {

  var splitURL = url.split("/");

  if ( splitURL[0] == "http:" || splitURL[0] == "https:") {
    var tld = splitURL[2].split(".");

    if ( tld[0] == "www" ) {
      if (tld.length == 3) {
        return tld[1];
      } else {
        return splitURL[2].split("www.")[1];
      }
    } else if (tld.length == 2) {
      return tld[0];
    } else {
      return splitURL[2];
    }
  } else {
    return false;
  }

}

EOJS

set runtimepath=$HOME/.vimperator
source! $HOME/.vimperatorrc.local

" vim: set ft=vimperator:
